# React合成事件

[React合成事件](https://juejin.cn/post/6955636911214067720)
[React合成事件](https://juejin.cn/post/6844903988794671117#heading-2)

## 什么是原生事件、合成事件？

- 原生事件：  在 componentDidMount生命周期里边进行addEventListener绑定的事件
- 合成事件： 通过 JSX 方式绑定的事件，比如 onClick={() => this.handle()}
合成事件的触发是基于浏览器的事件机制来实现的，通过冒泡机制冒泡到最顶层元素，然后再由 dispatchEvent 统一去处理。在react中，我们绑定的事件onClick等，并不是原生事件，而是由原生事件合成的React事件，比如 click事件合成为onClick事件。比如blur , change , input , keydown , keyup等 , 合成为onChange。

### 阻止合成事件，原生事件会执行吗？

会， 因为原生事件先于合成事件执行 (个人理解: 注册的原生事件已经执行，而合成事件处于目标阶段，它阻止的冒泡只是阻止合成的事件冒泡，但是原生事件在捕获阶段就已经执行了)

## 合成事件特点

React 自己实现了这么一套事件机制，它在 DOM 事件体系基础上做了改进，减少了内存的消耗，并且最大程度上解决了 IE 等浏览器的不兼容问题。

1. 我们在 jsx 中绑定的事件(onClick、onChange等),根本就没有注册到真实的dom上。是绑定在document上统一管理的。
2. 通过队列的形式，从触发的组件向父组件回溯，然后调用他们JSX中定义的callback
3. React 有一套自己的合成事件 SyntheticEvent，不是原生的，可以去看官网
4. React 通过对象池的形式管理合成事件对象的创建和销毁，减少了垃圾的生成和新对象内存的分配，提高了性能。

### 原理

1. react对事件是怎么合成的？
   - 维护了react合成事件名和事件处理插件的映射关系,维护合成事件和原生事件对应关系。
   - 插件中又有两个属性 1. eventTypes(合成事件在捕获、冒泡阶段触发对应的名字) 2.  extractEvents事件统一处理函数
这个阶段主要是初始化 1. React合成事件和原生事件的对应关系 2. 合成事件和对应的事件处理插件关系

2. react事件怎么绑定？
    - 在react中，diff dom元素的fiber的props，如果发现是react合成事件，会按照事件系统逻辑单独处理。
    - 根据react合成事件类型，找到对应的原生事件类型，判断原生事件类型，大部分事件都按照冒泡逻辑处理，少数事件会按照捕获逻辑处理（比如scroll事件）。
    - 调用 addTrappedEventListener 进行真正的事件绑定，绑定在document上，dispatchEvent 为统一的事件处理函
    - 只有上述那几个特殊事件比如 scorll,focus,blur等是在事件捕获阶段发生的，其他的都是在事件冒泡阶段发生的，无论是onClick还是onClickCapture都是发生在冒泡阶段，至于 React 本身怎么处理捕获逻辑的。我们接下来会讲到。
  
3. react事件触发流程?
    - 1. 出发dispatchevent,此时会设置批量更新这个变量为true => react进行批量更新
    - 2. 执行时间对应的处理插件中的extractEvents，合成事件源对象，react会从事件源开始，从上遍历类行为hostcomponent即dom类型的fiber,判断props是否有当前时间，最终形成一个时间执行队列，react就是用这个队列，来模拟事件捕获=>事件源=>事件冒泡这一过程。
    - 3. 最后通过runEventsInBatch执行事件队列，如果发现阻止冒泡，那么break跳出循环，最后重置事件源，放回到事件池中，完成整个流程。