[toc]

# 性能监控方案

## Web性能计时

[w3c文档](https://w3c.github.io/perf-timing-primer/)
下面是w3c文档的性能图片
![性能图片](./performance.jpg)

大致可以分为几个过程

(页面卸载、重定向 => 查看页面缓存) => 页面请求 => 请求响应 => 页面渲染

## 性能指标确定

### 网络资源获取

#### DNS
定义：dns寻址时间
采集方式：
PerformanceResourceTiming Api
公式：
PerformanceResourceTiming.domainLookupEnd - PerformanceResourceTiming.domainLookupStart
兼容情况：

![[Pasted image 20220625180854.png]]

#### TCP建立请求
定义：tcp链接建立时间
采集方式：
PerformanceResourceTiming Api
公式：
PerformanceResourceTiming.connectEnd - PerformanceResourceTiming.connectStart
兼容情况：
![[Pasted image 20220627013756.png]]
#### Request时间
定义：链接建立后到发送http request时间
采集方式：
PerformanceResourceTiming Api
公式：
PerformanceResourceTiming.responseStart - PerformanceResourceTiming.requestStart
兼容性：
![[Pasted image 20220627133023.png]]

#### TTFB首字节传输
定义：
Time To First Byte, 首字节时间 (TTFB) 有助于识别 Web 服务器何时响应请求太慢。
采集方式：
web-vitals  measures the elapsed time between `startTime` and `responseStart`.
公式：
兼容情况：
![[Pasted image 20220627093425.png]]
#### DOMReady
定义：
dom树构建完成
采集方式：
PerformanceResourceTiming Api、PerformanceNavigationTiming Api
公式：
PerformanceNavigationTiming.loadEventEnd. - PerformanceResourceTiming.responseEnd
兼容情况：
![[Pasted image 20220627013630.png]]
#### FP
定义：Fisrt Paint
采集方式：
web-vitals采集 + 
公式：
PerformanceNavigationTiming.loadEventEnd. - PerformanceResourceTiming.responseEnd
兼容情况：
![[Pasted image 20220627095347.png]]

#### FCP
定义：Fisrt Content Paint
采集方式：
web-vitals采集 + 
公式：
PerformanceNavigationTiming.loadEventEnd. - PerformanceResourceTiming.responseEnd
兼容情况：
![[Pasted image 20220627101522.png]]
#### LCP
定义：Fisrt Content Paint
采集方式：
web-vitals采集 + MutationObserver监听load事件出触发前dom变化最长时间节点
兼容情况
MutationObserver兼容情况
![[Pasted image 20220627101824.png]]


#### CLS
定义：Fisrt Content Paint
采集方式：
web-vitals采集 + MutationObserver监听load事件出触发前dom变化最长时间节点
兼容情况
![[Pasted image 20220627110201.png]]
#### FPS

#### FID


## 上报时机
### 默认上报时机
1. 触发FID上报
2. load事件出发后10s后页面如果没上报过则触发上报 监听load
3. 页面隐藏的时候上报 监听pageHide

## 自定义上报
暴露 handleReportData
使用用户调用时的时间戳 - timeOrigin时间戳
## 公共参数
